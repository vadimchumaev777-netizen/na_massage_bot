const TelegramBot = require("node-telegram-bot-api")
const express = require("express")

// Создаем Express сервер (это исправляет ошибку!)
const app = express()
const port = process.env.PORT || 10000

// HTTP endpoint для Render
app.get('/', (req, res) => {
  res.json({ 
    status: 'OK', 
    message: '🤖 Бот массажистки Алёны работает!',
    timestamp: new Date().toISOString()
  })
})

// Запускаем HTTP сервер
app.listen(port, () => {
  console.log(`🌐 HTTP сервер запущен на порту ${port}`)
})

// Создаем Telegram бота
const token = process.env.TOKEN
if (!token) {
  console.error('❌ Токен не найден! Проверьте переменную TOKEN')
  process.exit(1)
}

const bot = new TelegramBot(token, { polling: true })

// Главное меню
const mainMenu = {
  reply_markup: {
    keyboard: [
      ["📅 Записаться на массаж", "💰 Прайс-лист"],
      ["👩‍⚕️ О специалисте", "❓ Частые вопросы"],
      ["📞 Контакты", "📍 Адрес и время работы"],
    ],
    resize_keyboard: true,
  },
}

// Стартовое сообщение
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id
  const firstName = msg.from.first_name || "Друг"

  const welcomeMessage = `
🌟 *Добро пожаловать, ${firstName}!*

Меня зовут *Алёна*, и я специалист по детскому массажу.

👩‍⚕️ *Моя квалификация:*
• Дипломированная медицинская сестра
• Профессиональная переподготовка по детскому массажу
• Более 5 лет практики работы с детьми

🎯 *Я помогаю при:*
✔️ Нарушениях мышечного тонуса
✔️ Кривошее
✔️ Коликах и запорах
✔️ Сколиозе и нарушении осанки
✔️ Проблемах со стопами

💝 *Мой подход:*
• Индивидуальный подход к каждому ребенку
• Комфортная атмосфера
• Работа на основе медицинских знаний

🎯 *Моя цель* — помочь вашему малышу расти здоровым!

Выберите нужный пункт в меню ⬇️
  `

  bot.sendMessage(chatId, welcomeMessage, {
    parse_mode: "Markdown",
    ...mainMenu,
  })
})

// Обработка сообщений
bot.on("message", (msg) => {
  const chatId = msg.chat.id
  const text = msg.text

  if (text === "/start") return

  switch (text) {
    case "📅 Записаться на массаж":
      bot.sendMessage(chatId, `
📅 *ЗАПИСЬ НА ДЕТСКИЙ МАССАЖ*

Для записи свяжитесь со мной:

📱 *Телефон:* +7 (914) 993-57-73
💬 *WhatsApp:* +7 (914) 993-57-73
📧 *Email:* alena.massage@mail.ru

⏰ *Время работы:*
Пн-Пт: 9:00 - 18:00
Сб: 10:00 - 16:00
Вс: выходной

📋 *Для записи сообщите:*
• Имя и возраст ребенка
• Тип массажа
• Предпочитаемое время

Жду вашего обращения! 💌
      `, {
        parse_mode: "Markdown",
        reply_markup: {
          inline_keyboard: [
            [{ text: "📱 Позвонить", url: "tel:+79149935773" }],
            [{ text: "💬 WhatsApp", url: "https://wa.me/79149935773?text=Здравствуйте! Хочу записаться на детский массаж" }],
            [{ text: "📧 Email", url: "mailto:alena.massage@mail.ru" }],
          ],
        },
      })
      break

    case "💰 Прайс-лист":
      bot.sendMessage(chatId, `
💰 *ПРАЙС-ЛИСТ ДЕТСКИЙ МАССАЖ*

👶 *Общеукрепляющий массаж (0-13 лет)*
Стоимость: 950₽ за сеанс

💪 *Массаж при мышечной дистонии*
Стоимость: 950₽ за сеанс

🏥 *Массаж при сколиозе (4-7 лет)*
Стоимость: 700₽ за сеанс

🤱 *Массаж при коликах/запорах*
• До 1 года: 500₽ + обучение мам
• От 1 до 4 лет: 750₽

🦴 *Массаж кривошеи*
• До 1 года: 650₽
• От 1 до 4 лет: 750₽
• От 4 до 13 лет: 800₽

🦶 *Массаж стоп (4-13 лет)*
Стоимость: 950₽ за сеанс

📋 *Рекомендуемый курс:* 10-15 сеансов

📱 *Записаться:* +7 (914) 993-57-73
      `, { parse_mode: "Markdown", ...mainMenu })
      break

    case "👩‍⚕️ О специалисте":
      bot.sendMessage(chatId, `
👩‍⚕️ *АЛЁНА - СПЕЦИАЛИСТ ПО ДЕТСКОМУ МАССАЖУ*

🎓 *Образование:*
• Дипломированная медицинская сестра
• Профессиональная переподготовка по детскому массажу
• Более 5 лет успешной практики

🏥 *Специализация:*
✔️ Нарушения мышечного тонуса
✔️ Кривошея
✔️ Пупочная грыжа
✔️ Колики и запоры у младенцев
✔️ Сколиоз и нарушения осанки
✔️ Проблемы стоп
✔️ Общеукрепляющий массаж

💝 *Мой подход:*
• Работа на основе медицинских знаний
• Индивидуальный подход к каждому ребенку
• Комфортная атмосфера для малышей
• Обучение родителей элементам массажа

💌 *Моя миссия* — помочь каждому ребенку расти здоровым!
      `, { parse_mode: "Markdown", ...mainMenu })
      break

    case "❓ Частые вопросы":
      bot.sendMessage(chatId, `
❓ *ЧАСТЫЕ ВОПРОСЫ*

*Q: Массаж поможет выровнять спину у ребенка 7 лет?*
A: Да, массаж — важная часть лечения. Необходим комплекс: массаж + ЛФК + контроль ортопеда.

*Q: С какого возраста можно делать массаж?*
A: Профилактический — с 1 месяца. Лечебный — по показаниям врача с первых недель.

*Q: Какой курс нужен?*
A: Стандартный курс — 10-15 сеансов. Для стойкого результата повторять 2-4 раза в год.

*Q: Работаете с подростками?*
A: Да, до 13 лет. Рекомендую консультацию ортопеда.

*Q: Что эффективнее: массаж или ЛФК?*
A: Это дополняющие процедуры. Максимальный эффект — их комбинация.
      `, { parse_mode: "Markdown", ...mainMenu })
      break

    case "📞 Контакты":
      bot.sendMessage(chatId, `
📞 *КОНТАКТЫ*

👩‍⚕️ *Специалист:* Алёна
🏥 *Детский массаж*

📱 *Телефон:* +7 (914) 993-57-73
📧 *Email:* alena.massage@mail.ru
💬 *WhatsApp:* +7 (914) 993-57-73

⏰ *Время работы:*
Понедельник - Пятница: 9:00 - 18:00
Суббота: 10:00 - 16:00
Воскресенье: выходной

📍 *Прием:* На дому у клиента или в кабинете
🚗 *Выезд:* По Чехову и ближайшему Подмосковью

⚡ *Быстрая связь:*
Отвечаю в течение 1-2 часов

💌 *Буду рада помочь вашему малышу!*
      `, {
        parse_mode: "Markdown",
        reply_markup: {
          inline_keyboard: [
            [{ text: "📱 Позвонить", url: "tel:+79149935773" }],
            [{ text: "💬 WhatsApp", url: "https://wa.me/79149935773" }],
            [{ text: "📧 Email", url: "mailto:alena.massage@mail.ru" }],
          ],
        },
      })
      break

    case "📍 Адрес и время работы":
      bot.sendMessage(chatId, `
📍 *АДРЕС И ВРЕМЯ РАБОТЫ*

🏠 *Форматы работы:*
• Выезд на дом к клиенту (предпочтительно)
• Прием в оборудованном кабинете

📍 *География:*
• г. Чехов (все районы)
• Ближайшее Подмосковье

⏰ *Расписание:*
*Понедельник - Пятница:* 9:00 - 18:00
*Суббота:* 10:00 - 16:00
*Воскресенье:* выходной

🚗 *Выезд на дом:*
• Удобно для малышей
• Привычная обстановка
• Стерильные инструменты

📞 *Запись:* +7 (914) 993-57-73

*Выберу оптимальное время для вас!* 💝
      `, { parse_mode: "Markdown", ...mainMenu })
      break

    default:
      bot.sendMessage(chatId, `
💌 *Спасибо за сообщение!*

Ваш запрос: "${text}"

Свяжусь с вами для обсуждения массажа для вашего ребенка.

📱 *Или звоните:* +7 (914) 993-57-73
💬 *WhatsApp:* +7 (914) 993-57-73
📧 *Email:* alena.massage@mail.ru

⏰ *Отвечу в течение 1-2 часов!*

Буду рада помочь! 🌟
      `, { parse_mode: "Markdown", ...mainMenu })
  }
})

// Обработка ошибок
bot.on("polling_error", (error) => {
  console.log("❌ Polling error:", error.message)
})

console.log("🤖 Бот массажистки Алёны запущен!")
console.log("📱 Telegram polling активен")
